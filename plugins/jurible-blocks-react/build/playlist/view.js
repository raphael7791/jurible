!function(){"use strict";const e={containers:[],init:function(){this.initAllPlaylists(),this.observeNewPlaylists()},initAllPlaylists:function(){document.querySelectorAll(".jurible-playlist-container:not([data-initialized])").forEach(e=>this.initPlaylist(e))},observeNewPlaylists:function(){new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&((e.querySelectorAll?e.querySelectorAll(".jurible-playlist-container:not([data-initialized])"):[]).forEach(e=>this.initPlaylist(e)),e.classList&&e.classList.contains("jurible-playlist-container")&&!e.dataset.initialized&&this.initPlaylist(e))})})}).observe(document.body,{childList:!0,subtree:!0})},initPlaylist:function(e){const t=e.dataset.collectionId,i=e.dataset.collectionName;t?(e.dataset.initialized="true",e.innerHTML='<div class="playlist-loading">Chargement de la playlist...</div>',this.fetchVideos(t).then(n=>{0!==n.length?this.renderPlaylist(e,t,i,n):e.innerHTML='<div class="playlist-error">Aucune vidéo dans cette collection</div>'}).catch(t=>{console.error("Error loading playlist:",t),e.innerHTML='<div class="playlist-error">Erreur lors du chargement de la playlist</div>'})):e.innerHTML='<div class="playlist-error">Aucune collection sélectionnée</div>'},fetchVideos:function(e){return fetch("/wp-json/jurible/v1/bunny/collections/"+e+"/videos").then(e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()}).then(e=>{if(e.success&&e.videos)return e.videos;throw new Error("Invalid response")})},renderPlaylist:function(e,t,i,n){const l=n[0],s=window.juriblePlaylistConfig?.pullZoneUrl||"https://iframe.mediadelivery.net/embed/35843/",o=window.wpApiSettings?.nonce||"",r=!!o;e.innerHTML=`\n                <div class="jurible-playlist" data-collection="${t}">\n                    <div class="jurible-player-container">\n                        <div class="jurible-player-wrapper">\n                            <iframe\n                                id="jurible-player-${t}"\n                                src="${s}${l.id}?autoplay=false&preload=true"\n                                loading="lazy"\n                                allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;"\n                                allowfullscreen="true"\n                            ></iframe>\n                        </div>\n                        <div class="jurible-player-info">\n                            <h3 class="jurible-current-title">${l.title}</h3>\n                        </div>\n                    </div>\n\n                    <div class="jurible-playlist-controls">\n                        <div class="jurible-playlist-header">\n                            <span class="jurible-video-count">${n.length} vidéos</span>\n                            <span class="jurible-progress-count">\n                                <span class="jurible-completed-count">0</span>/${n.length} terminées\n                            </span>\n                        </div>\n                        <label class="jurible-autoplay-toggle">\n                            <input type="checkbox" id="jurible-autoplay-${t}" checked>\n                            <span class="jurible-toggle-slider"></span>\n                            <span class="jurible-toggle-label">Lecture auto</span>\n                        </label>\n                    </div>\n\n                    <div class="jurible-collection-progress">\n                        <div class="jurible-progress-bar">\n                            <div class="jurible-progress-fill" style="width: 0%"></div>\n                        </div>\n                    </div>\n\n                    <div class="jurible-video-list">\n                        ${n.map((e,t)=>`\n                            <div class="jurible-video-item${0===t?" active":""}"\n                                 data-video-id="${e.id}"\n                                 data-index="${t}">\n                                <span class="jurible-video-number">${t+1}</span>\n                                <div class="jurible-video-thumbnail">\n                                    <img src="${e.thumbnail}" alt="${e.title}" loading="lazy">\n                                    ${0===t?'\n                                        <div class="jurible-now-playing">\n                                            <span></span><span></span><span></span>\n                                        </div>\n                                    ':""}\n                                </div>\n                                <div class="jurible-video-info">\n                                    <span class="jurible-video-title">${e.title}</span>\n                                    <span class="jurible-video-duration">${e.durationFormatted}</span>\n                                </div>\n                            </div>\n                        `).join("")}\n                    </div>\n                </div>\n            `,this.initPlayerControls(e,t,n,s,r,o)},initPlayerControls:function(e,t,i,n,l,s){e.querySelector(".jurible-playlist");const o=e.querySelector(`#jurible-player-${t}`),r=e.querySelectorAll(".jurible-video-item"),a=e.querySelector(`#jurible-autoplay-${t}`),c=e.querySelector(".jurible-current-title"),d=e.querySelector(".jurible-progress-fill"),u=e.querySelector(".jurible-completed-count");let p=0,v=i[0].id,y=!0,b={},h=Date.now();function j(t,l){r.forEach(e=>{e.classList.remove("active");const t=e.querySelector(".jurible-now-playing");t&&t.remove()});const s=e.querySelector(`.jurible-video-item[data-video-id="${t}"]`);if(s){s.classList.add("active");const e=s.querySelector(".jurible-video-thumbnail");e&&e.insertAdjacentHTML("beforeend",'<div class="jurible-now-playing"><span></span><span></span><span></span></div>')}c.textContent=i[l].title,o.src=n+t+"?autoplay=true&preload=true",v=t,p=l,h=Date.now(),g(t),function(){const t=e.querySelector(".jurible-video-list"),i=e.querySelector(".jurible-video-item.active");if(t&&i){const e=t.getBoundingClientRect(),n=i.getBoundingClientRect();(n.top<e.top||n.bottom>e.bottom)&&i.scrollIntoView({behavior:"smooth",block:"center"})}}()}function g(e){l&&!b[e]&&m(e,"started",0)}function f(e){l&&(b[e]&&b[e].completed||(m(e,"completed",Math.floor((Date.now()-h)/1e3)),b[e]={status:"completed",completed:!0},w(e,!0),S()))}function m(e,i,n){fetch("/wp-json/jurible-playlist/v1/progress",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":s},body:JSON.stringify({video_id:e,collection_id:t,status:i,watch_time:n})}).catch(e=>console.log("Progress save error:",e))}function w(t,i){const n=e.querySelector(`.jurible-video-item[data-video-id="${t}"]`);n&&i&&!n.classList.contains("completed")&&(n.classList.add("completed"),n.querySelector(".jurible-video-completed")||n.insertAdjacentHTML("beforeend",'\n                            <div class="jurible-video-completed">\n                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">\n                                    <polyline points="20 6 9 17 4 12"></polyline>\n                                </svg>\n                            </div>\n                        '))}function S(){let e=0;Object.values(b).forEach(t=>{(t.completed||"completed"===t.status)&&e++});const t=i.length>0?e/i.length*100:0;d.style.width=t+"%",u.textContent=e}l&&fetch("/wp-json/jurible-playlist/v1/progress/"+t,{headers:{"X-WP-Nonce":s}}).then(e=>e.json()).then(e=>{e.success&&e.progress&&(b=e.progress,Object.keys(b).forEach(e=>{const t=b[e];(t.completed||"completed"===t.status)&&w(e,!0)}),S())}).catch(e=>console.log("Progress load error:",e)),r.forEach(e=>{e.addEventListener("click",function(){j(this.dataset.videoId,parseInt(this.dataset.index,10))})}),a&&a.addEventListener("change",function(){y=this.checked}),window.addEventListener("message",function(e){if(e.origin.includes("mediadelivery.net")||e.origin.includes("bunnycdn"))try{let t=e.data;"string"==typeof t&&(t=JSON.parse(t)),"videoEnded"!==t.event&&"ended"!==t.type||(f(v),y&&p<i.length-1&&setTimeout(()=>j(i[p+1].id,p+1),1e3)),("videoProgress"===t.event||"progress"===t.type)&&(t.percent||t.progress||0)>=.9&&f(v),"videoPlay"!==t.event&&"play"!==t.type||g(v)}catch(e){}})}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>e.init()):e.init()}();